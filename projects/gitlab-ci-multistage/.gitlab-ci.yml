variables:
  APP_NAME: gitlab-fastapi-app
  DOCKER_REGISTRY: $CI_REGISTRY
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE/$APP_NAME
  DOCKER_TAG: $CI_COMMIT_SHORT_SHA
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  POSTGRES_DB: testdb
  POSTGRES_USER: testuser
  POSTGRES_PASSWORD: testpass
  AWS_DEFAULT_REGION: us-east-1
  ECS_CLUSTER: production-cluster

stages:
  - lint
  - test
  - security-scan
  - build
  - deploy-staging
  - integration-test
  - deploy-prod

# -----------------------------------------------------------
# Global defaults
# -----------------------------------------------------------
default:
  image: python:3.12-slim
  before_script:
    - pip install --upgrade pip
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

cache:
  key:
    files:
      - requirements.txt
      - requirements-dev.txt
  paths:
    - .cache/pip
    - .venv/

# -----------------------------------------------------------
# Stage: Lint
# -----------------------------------------------------------
lint:ruff:
  stage: lint
  script:
    - pip install ruff mypy
    - ruff check src/ tests/
    - ruff format --check src/ tests/
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

lint:mypy:
  stage: lint
  script:
    - pip install -r requirements.txt -r requirements-dev.txt
    - mypy src/ --ignore-missing-imports
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# -----------------------------------------------------------
# Stage: Test
# -----------------------------------------------------------
test:unit:
  stage: test
  services:
    - name: postgres:16-alpine
      alias: postgres
    - name: redis:7-alpine
      alias: redis
  variables:
    DATABASE_URL: "postgresql://$POSTGRES_USER:$POSTGRES_PASSWORD@postgres:5432/$POSTGRES_DB"
    REDIS_URL: "redis://redis:6379"
  script:
    - pip install -r requirements.txt -r requirements-dev.txt
    - pytest tests/unit/ -v --junitxml=report-unit.xml --cov=src --cov-report=html:coverage-html --cov-report=xml:coverage.xml
  coverage: '/(?i)total.*?(\d+(?:\.\d+)?\%)/'
  artifacts:
    when: always
    paths:
      - coverage-html/
      - coverage.xml
    reports:
      junit: report-unit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

test:integration:
  stage: test
  services:
    - name: postgres:16-alpine
      alias: postgres
    - name: redis:7-alpine
      alias: redis
  variables:
    DATABASE_URL: "postgresql://$POSTGRES_USER:$POSTGRES_PASSWORD@postgres:5432/$POSTGRES_DB"
    REDIS_URL: "redis://redis:6379"
  script:
    - pip install -r requirements.txt -r requirements-dev.txt
    - pytest tests/integration/ -v --junitxml=report-integration.xml
  artifacts:
    when: always
    reports:
      junit: report-integration.xml
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# -----------------------------------------------------------
# Stage: Security Scan
# -----------------------------------------------------------
security:sast:
  stage: security-scan
  image: python:3.12-slim
  script:
    - pip install bandit safety
    - bandit -r src/ -f json -o bandit-report.json || true
    - bandit -r src/ -f html -o bandit-report.html || true
    - safety check --output json > safety-report.json 2>&1 || true
  artifacts:
    when: always
    paths:
      - bandit-report.json
      - bandit-report.html
      - safety-report.json
    expire_in: 30 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

security:container-scan:
  stage: security-scan
  image:
    name: aquasec/trivy:latest
    entrypoint: [""]
  variables:
    TRIVY_NO_PROGRESS: "true"
    TRIVY_CACHE_DIR: ".trivycache/"
  script:
    - trivy image --exit-code 0 --severity LOW,MEDIUM --format json --output trivy-low-medium.json $DOCKER_IMAGE:$DOCKER_TAG || true
    - trivy image --exit-code 1 --severity HIGH,CRITICAL --format json --output trivy-high-critical.json $DOCKER_IMAGE:$DOCKER_TAG
  artifacts:
    when: always
    paths:
      - trivy-low-medium.json
      - trivy-high-critical.json
    expire_in: 30 days
  cache:
    key: trivy-cache
    paths:
      - .trivycache/
  needs:
    - job: build:docker
      artifacts: false
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

security:dast:
  stage: security-scan
  image:
    name: zaproxy/zap-stable:latest
    entrypoint: [""]
  variables:
    DAST_TARGET_URL: "https://staging.example.com"
  script:
    - mkdir -p /zap/wrk/
    - |
      zap-baseline.py \
        -t "${DAST_TARGET_URL}" \
        -J zap-report.json \
        -r zap-report.html \
        -I || true
    - cp /zap/wrk/zap-report.* . 2>/dev/null || true
  artifacts:
    when: always
    paths:
      - zap-report.json
      - zap-report.html
    expire_in: 30 days
  needs:
    - job: deploy:staging
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true

# -----------------------------------------------------------
# Stage: Build
# -----------------------------------------------------------
build:docker:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - |
      docker build \
        --target production \
        --tag $DOCKER_IMAGE:$DOCKER_TAG \
        --tag $DOCKER_IMAGE:latest \
        --build-arg BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
        --build-arg VCS_REF=$CI_COMMIT_SHORT_SHA \
        --cache-from $DOCKER_IMAGE:latest \
        .
    - docker push $DOCKER_IMAGE:$DOCKER_TAG
    - docker push $DOCKER_IMAGE:latest
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# -----------------------------------------------------------
# Stage: Deploy Staging
# -----------------------------------------------------------
deploy:staging:
  stage: deploy-staging
  image:
    name: amazon/aws-cli:latest
    entrypoint: [""]
  environment:
    name: staging
    url: https://staging.example.com
    on_stop: stop:staging
  script:
    - |
      ./scripts/deploy-blue-green.sh \
        --cluster $ECS_CLUSTER \
        --service ${APP_NAME}-staging \
        --image $DOCKER_IMAGE:$DOCKER_TAG \
        --region $AWS_DEFAULT_REGION \
        --environment staging
    - |
      ./scripts/smoke-test.sh \
        --url https://staging.example.com \
        --retries 10 \
        --delay 15
  needs:
    - job: build:docker
    - job: test:unit
    - job: test:integration
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

stop:staging:
  stage: deploy-staging
  image:
    name: amazon/aws-cli:latest
    entrypoint: [""]
  environment:
    name: staging
    action: stop
  script:
    - echo "Scaling down staging environment"
    - aws ecs update-service --cluster $ECS_CLUSTER --service ${APP_NAME}-staging --desired-count 0
  when: manual
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# -----------------------------------------------------------
# Stage: Integration Test (post-deploy)
# -----------------------------------------------------------
integration-test:staging:
  stage: integration-test
  script:
    - pip install httpx pytest
    - |
      export API_BASE_URL="https://staging.example.com"
      pytest tests/e2e/ -v --junitxml=report-e2e.xml
  artifacts:
    when: always
    reports:
      junit: report-e2e.xml
    expire_in: 7 days
  needs:
    - job: deploy:staging
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# -----------------------------------------------------------
# Stage: Deploy Production
# -----------------------------------------------------------
deploy:production:
  stage: deploy-prod
  image:
    name: amazon/aws-cli:latest
    entrypoint: [""]
  environment:
    name: production
    url: https://app.example.com
  script:
    - |
      ./scripts/deploy-blue-green.sh \
        --cluster $ECS_CLUSTER \
        --service ${APP_NAME}-production \
        --image $DOCKER_IMAGE:$DOCKER_TAG \
        --region $AWS_DEFAULT_REGION \
        --environment production
    - |
      ./scripts/smoke-test.sh \
        --url https://app.example.com \
        --retries 15 \
        --delay 20
  needs:
    - job: integration-test:staging
    - job: security:sast
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  allow_failure: false
