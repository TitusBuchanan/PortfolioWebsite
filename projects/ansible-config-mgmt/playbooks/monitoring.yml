---
- name: Configure monitoring agents
  hosts: all
  become: true
  gather_facts: true
  tags:
    - monitoring

  vars:
    node_exporter_version: "1.7.0"
    node_exporter_listen_address: "0.0.0.0:{{ node_exporter_port | default(9100) }}"
    node_exporter_enabled_collectors:
      - cpu
      - diskstats
      - filesystem
      - loadavg
      - meminfo
      - netdev
      - netstat
      - stat
      - time
      - vmstat
      - systemd
    promtail_version: "2.9.4"
    promtail_positions_file: /var/lib/promtail/positions.yaml
    promtail_scrape_configs:
      - job_name: system
        static_configs:
          - targets:
              - localhost
            labels:
              job: varlogs
              host: "{{ inventory_hostname }}"
              __path__: /var/log/*.log
      - job_name: nginx
        static_configs:
          - targets:
              - localhost
            labels:
              job: nginx
              host: "{{ inventory_hostname }}"
              __path__: /var/log/nginx/*.log

  roles:
    - role: monitoring
      tags: monitoring

  post_tasks:
    - name: Verify node_exporter is responding
      ansible.builtin.uri:
        url: "http://localhost:{{ node_exporter_port | default(9100) }}/metrics"
        return_content: false
        status_code: 200
      register: exporter_check
      retries: 3
      delay: 5
      until: exporter_check.status == 200

    - name: Verify promtail is running
      ansible.builtin.service_facts:

    - name: Assert promtail service is active
      ansible.builtin.assert:
        that:
          - "'promtail.service' in services"
          - "services['promtail.service'].state == 'running'"
        fail_msg: "Promtail is not running"
        success_msg: "Promtail is running successfully"
