---
- name: Install Nginx and dependencies
  ansible.builtin.apt:
    name:
      - nginx
      - certbot
      - python3-certbot-nginx
      - openssl
      - ufw
    state: present
    update_cache: true
    cache_valid_time: 3600

- name: Ensure Nginx directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop:
    - /etc/nginx/sites-available
    - /etc/nginx/sites-enabled
    - /etc/nginx/snippets
    - /etc/nginx/conf.d
    - /var/www/html
    - /var/log/nginx

- name: Deploy main Nginx configuration
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    owner: root
    group: root
    mode: "0644"
    validate: nginx -t -c %s
  notify: reload nginx

- name: Deploy SSL parameters snippet
  ansible.builtin.copy:
    dest: /etc/nginx/snippets/ssl-params.conf
    owner: root
    group: root
    mode: "0644"
    content: |
      ssl_protocols {{ ssl_protocols | default('TLSv1.2 TLSv1.3') }};
      ssl_ciphers {{ ssl_ciphers | default('HIGH:!aNULL:!MD5') }};
      ssl_prefer_server_ciphers on;
      ssl_session_cache shared:SSL:10m;
      ssl_session_timeout 1d;
      ssl_session_tickets off;
      ssl_stapling on;
      ssl_stapling_verify on;
      add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
      add_header X-Frame-Options DENY always;
      add_header X-Content-Type-Options nosniff always;
      add_header X-XSS-Protection "1; mode=block" always;
      add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  notify: reload nginx

- name: Deploy virtual host configurations
  ansible.builtin.copy:
    dest: "/etc/nginx/sites-available/{{ item }}.conf"
    owner: root
    group: root
    mode: "0644"
    content: |
      server {
          listen 80;
          listen [::]:80;
          server_name {{ item }};
          return 301 https://$server_name$request_uri;
      }

      server {
          listen 443 ssl http2;
          listen [::]:443 ssl http2;
          server_name {{ item }};

          ssl_certificate {{ ssl_cert_path }}/{{ item }}.pem;
          ssl_certificate_key {{ ssl_key_path }}/{{ item }}.key;
          include snippets/ssl-params.conf;

          root /var/www/{{ item }};
          index index.html index.htm;

          access_log /var/log/nginx/{{ item }}_access.log;
          error_log /var/log/nginx/{{ item }}_error.log;

          location / {
              try_files $uri $uri/ =404;
          }

          location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff2)$ {
              expires 30d;
              add_header Cache-Control "public, immutable";
          }
      }
  loop: "{{ server_names | default(['example.com']) }}"
  notify: reload nginx

- name: Enable virtual host configurations
  ansible.builtin.file:
    src: "/etc/nginx/sites-available/{{ item }}.conf"
    dest: "/etc/nginx/sites-enabled/{{ item }}.conf"
    state: link
  loop: "{{ server_names | default(['example.com']) }}"
  notify: reload nginx

- name: Remove default Nginx site
  ansible.builtin.file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: reload nginx

- name: Generate self-signed SSL certificates for initial setup
  ansible.builtin.command:
    cmd: >
      openssl req -x509 -nodes -days 365
      -newkey rsa:2048
      -keyout {{ ssl_key_path }}/{{ item }}.key
      -out {{ ssl_cert_path }}/{{ item }}.pem
      -subj "/CN={{ item }}/O=Organization/C=US"
    creates: "{{ ssl_cert_path }}/{{ item }}.pem"
  loop: "{{ server_names | default(['example.com']) }}"

- name: Set SSL certificate permissions
  ansible.builtin.file:
    path: "{{ ssl_key_path }}/{{ item }}.key"
    owner: root
    group: root
    mode: "0600"
  loop: "{{ server_names | default(['example.com']) }}"

- name: Configure UFW defaults
  community.general.ufw:
    direction: "{{ item.direction }}"
    policy: "{{ item.policy }}"
  loop:
    - { direction: incoming, policy: deny }
    - { direction: outgoing, policy: allow }

- name: Allow firewall ports
  community.general.ufw:
    rule: allow
    port: "{{ item.split('/')[0] }}"
    proto: "{{ item.split('/')[1] }}"
  loop: "{{ firewall_allowed_ports | default(['22/tcp', '80/tcp', '443/tcp']) }}"

- name: Enable UFW
  community.general.ufw:
    state: enabled

- name: Configure Nginx logrotate
  ansible.builtin.copy:
    dest: /etc/logrotate.d/nginx
    owner: root
    group: root
    mode: "0644"
    content: |
      /var/log/nginx/*.log {
          daily
          missingok
          rotate 14
          compress
          delaycompress
          notifempty
          create 0640 www-data adm
          sharedscripts
          prerotate
              if [ -d /etc/logrotate.d/httpd-prerotate ]; then
                  run-parts /etc/logrotate.d/httpd-prerotate
              fi
          endscript
          postrotate
              invoke-rc.d nginx rotate >/dev/null 2>&1
          endscript
      }

- name: Ensure Nginx is enabled and started
  ansible.builtin.service:
    name: nginx
    state: started
    enabled: true

- name: Set up certbot renewal cron
  ansible.builtin.cron:
    name: "Certbot renewal"
    minute: "0"
    hour: "3"
    weekday: "1"
    job: "certbot renew --quiet --nginx --post-hook 'systemctl reload nginx'"
    user: root

